<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT ìë§‰ ë²ˆì—­ê¸° - ë°ìŠ¤í¬íƒ‘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .logo h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e5e7;
        }

        .section-header h2 {
            font-size: 2em;
            margin-left: 15px;
        }

        .section-header i {
            font-size: 2em;
            color: #667eea;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .file-drop-zone {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .file-drop-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-icon {
            font-size: 4em;
            color: #ddd;
            margin-bottom: 20px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-info {
            background: #cce7ff;
            border: 1px solid #99d6ff;
            color: #004085;
        }

        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 6px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="logo">
                <h1>ğŸ¬ SRT ë²ˆì—­ê¸°</h1>
                <p>ë„¤ì´ë²„ í´ë¼ìš°ë“œ í”Œë«í¼</p>
            </div>
            
            <nav>
                <div class="nav-item active" data-section="config">
                    <i>âš™ï¸</i> API ì„¤ì •
                </div>
                <div class="nav-item" data-section="upload">
                    <i>ğŸ“</i> íŒŒì¼ ì—…ë¡œë“œ
                </div>
                <div class="nav-item" data-section="translate">
                    <i>ğŸŒ</i> ë²ˆì—­ ì„¤ì •
                </div>
                <div class="nav-item" data-section="process">
                    <i>ğŸš€</i> ë²ˆì—­ ì‹¤í–‰
                </div>
                <div class="nav-item" data-section="results">
                    <i>ğŸ“‹</i> ê²°ê³¼ í™•ì¸
                </div>
            </nav>
        </div>

        <div class="main-content">
            <!-- API ì„¤ì • ì„¹ì…˜ -->
            <div class="content-section active" id="config">
                <div class="section-header">
                    <i>âš™ï¸</i>
                    <h2>API ì„¤ì •</h2>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 20px;">ë„¤ì´ë²„ í´ë¼ìš°ë“œ í”Œë«í¼ ì¸ì¦ ì •ë³´</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="accessKey">Access Key *</label>
                            <input type="password" id="accessKey" placeholder="NCP Access Key ì…ë ¥">
                        </div>
                        <div class="form-group">
                            <label for="secretKey">Secret Key *</label>
                            <input type="password" id="secretKey" placeholder="NCP Secret Key ì…ë ¥">
                        </div>
                        <div class="form-group">
                            <label for="bucket">ë²„í‚· ì´ë¦„ *</label>
                            <input type="text" id="bucket" placeholder="Object Storage ë²„í‚· ì´ë¦„">
                        </div>
                        <div class="form-group">
                            <label for="clientId">Papago Client ID *</label>
                            <input type="text" id="clientId" placeholder="Papago Translation Client ID">
                        </div>
                        <div class="form-group">
                            <label for="clientSecret">Papago Client Secret *</label>
                            <input type="password" id="clientSecret" placeholder="Papago Translation Client Secret">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveConfig()">
                        <i>ğŸ’¾</i> ì„¤ì • ì €ì¥
                    </button>
                    
                    <div class="status-message status-success" id="configSaved">
                        âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!
                    </div>
                </div>
            </div>

            <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="content-section" id="upload">
                <div class="section-header">
                    <i>ğŸ“</i>
                    <h2>SRT íŒŒì¼ ì—…ë¡œë“œ</h2>
                </div>

                <div class="card">
                    <div class="file-drop-zone" onclick="document.getElementById('srtFileInput').click()">
                        <input type="file" id="srtFileInput" accept=".srt" style="display: none;">
                        <div class="file-icon">ğŸ“„</div>
                        <div>SRT íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                        <small>ì§€ì› í˜•ì‹: .srt íŒŒì¼</small>
                    </div>
                    
                    <div class="status-message status-error" id="fileError"></div>
                    <div class="status-message status-success" id="fileSuccess"></div>
                </div>
            </div>

            <!-- ë²ˆì—­ ì„¤ì • ì„¹ì…˜ -->
            <div class="content-section" id="translate">
                <div class="section-header">
                    <i>ğŸŒ</i>
                    <h2>ë²ˆì—­ ì„¤ì •</h2>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px;">ì–¸ì–´ ì„ íƒ</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="sourceLanguage">ì›ë³¸ ì–¸ì–´</label>
                            <select id="sourceLanguage">
                                <option value="auto">ìë™ ê°ì§€</option>
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="en">ì˜ì–´</option>
                                <option value="ja">ì¼ë³¸ì–´</option>
                                <option value="zh-CN">ì¤‘êµ­ì–´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="targetLanguage">ë²ˆì—­ ì–¸ì–´</label>
                            <select id="targetLanguage">
                                <option value="en">ì˜ì–´</option>
                                <option value="ja">ì¼ë³¸ì–´</option>
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="zh-CN">ì¤‘êµ­ì–´</option>
                                <option value="es">ìŠ¤í˜ì¸ì–´</option>
                                <option value="fr">í”„ë‘ìŠ¤ì–´</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë²ˆì—­ ì‹¤í–‰ ì„¹ì…˜ -->
            <div class="content-section" id="process">
                <div class="section-header">
                    <i>ğŸš€</i>
                    <h2>ë²ˆì—­ ì‹¤í–‰</h2>
                </div>

                <div class="card">
                    <button class="btn btn-primary" id="startBtn" onclick="startTranslation()" disabled>
                        <i>ğŸš€</i> ë²ˆì—­ ì‹œì‘
                    </button>
                    <button class="btn btn-primary" id="stopBtn" onclick="stopTranslation()" style="display: none; background: #dc3545; margin-left: 10px;">
                        <i>â¹ï¸</i> ë²ˆì—­ ì¤‘ë‹¨
                    </button>
                    
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">ë²ˆì—­ ì¤€ë¹„ ì¤‘...</div>
                    </div>
                    
                    <div class="status-message status-info" id="processStatus"></div>
                </div>
            </div>

            <!-- ê²°ê³¼ í™•ì¸ ì„¹ì…˜ -->
            <div class="content-section" id="results">
                <div class="section-header">
                    <i>ğŸ“‹</i>
                    <h2>ê²°ê³¼ í™•ì¸</h2>
                </div>

                <div class="card">
                    <h3>ë²ˆì—­ì´ ì™„ë£Œë˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</h3>
                    <p>ë²ˆì—­ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let srtContent = '';
        let srtBlocks = [];
        let translatedContent = '';
        let translationMapping = {};
        let isTranslating = false;
        let shouldStopTranslation = false;

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ë¡œë“œ ì™„ë£Œ');
            
            // ë„¤ë¹„ê²Œì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.dataset.section;
                    switchSection(sectionId);
                });
            });

            // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            document.getElementById('srtFileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.name.toLowerCase().endsWith('.srt')) {
                        processFile(file);
                    } else {
                        showMessage('fileError', 'SRT íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        hideMessage('fileSuccess');
                    }
                }
            });

            // ì„¤ì • ë³€ê²½ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
            ['accessKey', 'secretKey', 'bucket', 'clientId', 'clientSecret'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateProcessStatus);
            });
            
            // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            loadSavedConfig();
            
            // IPC ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ (ë©”ë‰´ì—ì„œ ë²ˆì—­ ì¤‘ë‹¨ ëª…ë ¹)
            if (typeof require !== 'undefined') {
                const { ipcRenderer } = require('electron');
                
                ipcRenderer.on('stop-translation', () => {
                    console.log('ë©”ë‰´ì—ì„œ ë²ˆì—­ ì¤‘ë‹¨ ìš”ì²­');
                    stopTranslation();
                });
            }
            
            console.log('ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ë„¤ë¹„ê²Œì´ì…˜ ê¸°ëŠ¥
        function switchSection(sectionId) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ì„ íƒëœ ì„¹ì…˜ ë³´ì´ê¸°
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // ì„ íƒëœ ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            const activeNav = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜
        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function hideMessage(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        // ì„¤ì • ì €ì¥ (ì•”í˜¸í™”)
        function saveConfig() {
            const config = {
                // Base64 ì¸ì½”ë”©ìœ¼ë¡œ ë‹¨ìˆœ ë‚œë…í™”
                accessKey: btoa(document.getElementById('accessKey').value || ''),
                secretKey: btoa(document.getElementById('secretKey').value || ''),
                bucket: document.getElementById('bucket').value || '',
                clientId: btoa(document.getElementById('clientId').value || ''),
                clientSecret: btoa(document.getElementById('clientSecret').value || '')
            };
            
            localStorage.setItem('srtTranslatorConfig', JSON.stringify(config));
            
            showMessage('configSaved', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            setTimeout(() => hideMessage('configSaved'), 3000);
            updateProcessStatus();
        }

        // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (ë³µí˜¸í™”)
        function loadSavedConfig() {
            const saved = localStorage.getItem('srtTranslatorConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    
                    // Base64 ë””ì½”ë”©
                    if (config.accessKey) {
                        document.getElementById('accessKey').value = atob(config.accessKey);
                    }
                    if (config.secretKey) {
                        document.getElementById('secretKey').value = atob(config.secretKey);
                    }
                    if (config.bucket) {
                        document.getElementById('bucket').value = config.bucket;
                    }
                    if (config.clientId) {
                        document.getElementById('clientId').value = atob(config.clientId);
                    }
                    if (config.clientSecret) {
                        document.getElementById('clientSecret').value = atob(config.clientSecret);
                    }
                    
                    updateProcessStatus();
                } catch (e) {
                    console.warn('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentNode.querySelector('.show-hide-btn');
            
            if (input.type === 'password') {
                input.type = 'text';
                input.classList.remove('secure-input');
                button.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                input.classList.add('secure-input');
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                srtContent = e.target.result;
                srtBlocks = parseSRT(srtContent);
                
                if (srtBlocks.length > 0) {
                    showMessage('fileSuccess', `íŒŒì¼ "${file.name}" ì—…ë¡œë“œ ì™„ë£Œ! (${srtBlocks.length}ê°œ ë¸”ë¡)`);
                    hideMessage('fileError');
                    updateProcessStatus();
                } else {
                    showMessage('fileError', 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ SRT íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
                    hideMessage('fileSuccess');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // SRT íŒŒì‹±
        function parseSRT(content) {
            const blocks = [];
            const rawBlocks = content.trim().split(/\r?\n\r?\n/);
            
            for (let rb of rawBlocks) {
                const lines = rb.split('\n');
                if (lines.length < 3) continue;
                
                const indexMatch = lines[0].trim().match(/^\d+$/);
                if (!indexMatch) continue;
                const index = parseInt(indexMatch[0]);
                
                const timeRegex = new RegExp('(\\d{2}:\\d{2}:\\d{2},\\d{3})\\s*-->\\s*(\\d{2}:\\d{2}:\\d{2},\\d{3})');
                const timeMatch = lines[1].match(timeRegex);
                if (!timeMatch) continue;
                
                const start = timeMatch[1];
                const end = timeMatch[2];
                const subtitleLines = lines.slice(2);
                
                blocks.push({
                    index: index,
                    start: start,
                    end: end,
                    lines: subtitleLines
                });
            }
            
            return blocks;
        }

        // ë²ˆì—­ ì¤€ë¹„ ìƒíƒœ í™•ì¸
        function updateProcessStatus() {
            const accessKey = document.getElementById('accessKey').value;
            const secretKey = document.getElementById('secretKey').value;
            const clientId = document.getElementById('clientId').value;
            const clientSecret = document.getElementById('clientSecret').value;
            const bucket = document.getElementById('bucket').value;
            
            const hasConfig = accessKey && secretKey && clientId && clientSecret && bucket;
            const hasFile = srtBlocks.length > 0;
            
            const startBtn = document.getElementById('startBtn');
            
            if (hasConfig && hasFile) {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i>ğŸš€</i> ë²ˆì—­ ì‹œì‘';
                showMessage('processStatus', `ì¤€ë¹„ ì™„ë£Œ! ${srtBlocks.length}ê°œ ë¸”ë¡ì´ ë²ˆì—­ë©ë‹ˆë‹¤.`);
            } else {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i>âš ï¸</i> ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”';
                
                let missing = [];
                if (!hasConfig) missing.push('API ì„¤ì •');
                if (!hasFile) missing.push('SRT íŒŒì¼');
                
                showMessage('processStatus', `ë¶€ì¡±í•œ í•­ëª©: ${missing.join(', ')}`);
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = message;
        }

        // ë²ˆì—­ ì¤‘ë‹¨ í•¨ìˆ˜
        function stopTranslation() {
            if (!isTranslating) return;
            
            shouldStopTranslation = true;
            console.log('ë²ˆì—­ ì¤‘ë‹¨ ìš”ì²­');
            
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i>â³</i> ì¤‘ë‹¨ ì¤‘...';
            
            updateProgress(0, 'ë²ˆì—­ì„ ì¤‘ë‹¨í•˜ëŠ” ì¤‘...');
        }

        // ë²ˆì—­ ì‹œì‘ - ì™„ì „í•œ ê¸°ëŠ¥ êµ¬í˜„
        async function startTranslation() {
            console.log('ë²ˆì—­ ì‹œì‘');
            
            isTranslating = true;
            shouldStopTranslation = false;
            
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            startBtn.disabled = true;
            startBtn.innerHTML = '<i>ğŸ”„</i> ë²ˆì—­ ì¤‘...';
            stopBtn.style.display = 'inline-flex';
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i>â¹ï¸</i> ë²ˆì—­ ì¤‘ë‹¨';
            
            try {
                updateProgress(5, 'ë²ˆì—­ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
                
                // ì„¤ì • ê°’ ê°€ì ¸ì˜¤ê¸°
                const config = {
                    accessKey: document.getElementById('accessKey').value,
                    secretKey: document.getElementById('secretKey').value,
                    bucket: document.getElementById('bucket').value,
                    clientId: document.getElementById('clientId').value,
                    clientSecret: document.getElementById('clientSecret').value,
                    sourceLanguage: document.getElementById('sourceLanguage').value,
                    targetLanguage: document.getElementById('targetLanguage').value
                };
                
                // ë²ˆì—­ ë‹¨ìœ„ ìƒì„±
                const units = [];
                for (let block of srtBlocks) {
                    for (let i = 0; i < block.lines.length; i++) {
                        if (block.lines[i].trim()) {
                            units.push([block.index, i + 1, block.lines[i]]);
                        }
                    }
                }
                
                updateProgress(10, `${units.length}ê°œ í…ìŠ¤íŠ¸ ë¼ì¸ì„ ë²ˆì—­ ì¤‘...`);
                
                // ë²ˆì—­ ì‹¤í–‰
                const resultMap = await translateUnits(units, config);
                
                if (shouldStopTranslation) {
                    throw new Error('ë²ˆì—­ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                updateProgress(90, 'SRT íŒŒì¼ ì¬êµ¬ì„± ì¤‘...');
                
                // SRT íŒŒì¼ ì¬êµ¬ì„±
                translatedContent = rebuildSRT(srtBlocks, resultMap);
                
                // ë§¤í•‘ ë°ì´í„° ìƒì„±
                translationMapping = {};
                units.forEach(([blockIndex, lineIndex, originalText]) => {
                    const key = `${blockIndex}:${lineIndex}`;
                    translationMapping[key] = {
                        original: originalText,
                        translated: resultMap[key] || originalText
                    };
                });
                
                updateProgress(100, 'ë²ˆì—­ ì™„ë£Œ!');
                
                // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ì´ë™í•˜ê³  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                switchSection('results');
                showTranslationResults(units.length);
                
                setTimeout(() => {
                    document.getElementById('progressContainer').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Translation error:', error);
                const errorMessage = shouldStopTranslation ? 'â¹ï¸ ë²ˆì—­ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'âŒ ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message;
                updateProgress(0, errorMessage);
            } finally {
                isTranslating = false;
                shouldStopTranslation = false;
                
                startBtn.disabled = false;
                startBtn.innerHTML = '<i>ğŸš€</i> ë²ˆì—­ ì‹œì‘';
                stopBtn.style.display = 'none';
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<i>â¹ï¸</i> ë²ˆì—­ ì¤‘ë‹¨';
                
                updateProcessStatus();
            }
        }

        // ë²ˆì—­ ì‹¤í–‰
        async function translateUnits(units, config) {
            const resultMap = {};
            
            for (let i = 0; i < units.length; i++) {
                // ì¤‘ë‹¨ ìš”ì²­ í™•ì¸
                if (shouldStopTranslation) {
                    console.log('ë²ˆì—­ ì¤‘ë‹¨ë¨ at unit', i);
                    break;
                }
                
                const [blockIndex, lineIndex, text] = units[i];
                
                try {
                    // íƒœê·¸ê°€ í¬í•¨ëœ í…ìŠ¤íŠ¸ ìƒì„±
                    const taggedText = `<B${blockIndex.toString().padStart(4, '0')}L${lineIndex.toString().padStart(2, '0')}/>${text}`;
                    
                    // Papago API í˜¸ì¶œ
                    const translatedText = await callPapagoAPI(
                        taggedText,
                        config.sourceLanguage,
                        config.targetLanguage,
                        config.clientId,
                        config.clientSecret
                    );
                    
                    // íƒœê·¸ ì œê±°í•˜ê³  ë²ˆì—­ ê²°ê³¼ ì¶”ì¶œ
                    const tagPattern = /<B(\d{4})L(\d{2})\/>/;
                    const match = translatedText.match(tagPattern);
                    if (match) {
                        const translatedSegment = translatedText.replace(tagPattern, '').trim();
                        resultMap[`${blockIndex}:${lineIndex}`] = translatedSegment;
                    } else {
                        resultMap[`${blockIndex}:${lineIndex}`] = translatedText;
                    }
                    
                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    const progress = Math.round(10 + (i + 1) / units.length * 80);
                    updateProgress(progress, `ë²ˆì—­ ì¤‘... ${i + 1}/${units.length}`);
                    
                    // API í˜¸ì¶œ ê°„ê²© (ê³¼ë¶€í•˜ ë°©ì§€)
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.warn(`ë²ˆì—­ ì‹¤íŒ¨ ${blockIndex}:${lineIndex}:`, error);
                    // ì‹¤íŒ¨í•œ ê²½ìš° ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
                    resultMap[`${blockIndex}:${lineIndex}`] = text;
                }
            }
            
            return resultMap;
        }

        // Papago API í˜¸ì¶œ
        async function callPapagoAPI(text, sourceLanguage, targetLanguage, clientId, clientSecret) {
            const url = 'https://papago.apigw.ntruss.com/nmt/v1/translation';
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-NCP-APIGW-API-KEY-ID': clientId,
                    'X-NCP-APIGW-API-KEY': clientSecret,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source: sourceLanguage,
                    target: targetLanguage,
                    text: text
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Papago API Error: ${errorData.errorMessage || response.statusText}`);
            }
            
            const data = await response.json();
            return data.message.result.translatedText;
        }

        // SRT íŒŒì¼ ì¬êµ¬ì„±
        function rebuildSRT(blocks, resultMap) {
            const lines = [];
            
            for (let block of blocks) {
                lines.push(block.index.toString());
                lines.push(`${block.start} --> ${block.end}`);
                
                for (let i = 0; i < block.lines.length; i++) {
                    const key = `${block.index}:${i + 1}`;
                    const translatedLine = resultMap[key] || block.lines[i];
                    lines.push(translatedLine);
                }
                
                lines.push(''); // ë¹ˆ ì¤„
            }
            
            return lines.join('\n');
        }

        // ê²°ê³¼ í‘œì‹œ
        function showTranslationResults(totalUnits) {
            const resultsSection = document.getElementById('results');
            const targetLanguage = document.getElementById('targetLanguage').value;
            
            resultsSection.innerHTML = `
                <div class="section-header">
                    <i>ğŸ“‹</i>
                    <h2>ê²°ê³¼ í™•ì¸</h2>
                </div>
                <div class="card">
                    <h3>âœ… ë²ˆì—­ ì™„ë£Œ!</h3>
                    <p>${totalUnits}ê°œ í…ìŠ¤íŠ¸ ë¼ì¸ì´ ${targetLanguage.toUpperCase()}ë¡œ ë²ˆì—­ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    
                    <div style="margin: 20px 0; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="downloadTranslatedSRT()">
                            <i>ğŸ“¥</i> ë²ˆì—­ëœ SRT ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="btn btn-success" onclick="downloadMappingJSON()">
                            <i>ğŸ“„</i> ë§¤í•‘ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                    
                    <h4>ë²ˆì—­ ë¯¸ë¦¬ë³´ê¸°:</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-line; max-height: 300px; overflow-y: auto; border: 1px solid #ddd;">
${translatedContent.split('\n').slice(0, 20).join('\n')}
${translatedContent.split('\n').length > 20 ? '...\n(ë” ë§ì€ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤)' : ''}
                    </div>
                </div>
            `;
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadTranslatedSRT() {
            if (!translatedContent) {
                alert('ë²ˆì—­ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const targetLanguage = document.getElementById('targetLanguage').value;
            const filename = `translated_${targetLanguage}_${Date.now()}.srt`;
            
            const blob = new Blob([translatedContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadMappingJSON() {
            if (!translationMapping || Object.keys(translationMapping).length === 0) {
                alert('ë§¤í•‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const filename = `translation_mapping_${Date.now()}.json`;
            const jsonContent = JSON.stringify(translationMapping, null, 2);
            
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        console.log('SRT ë²ˆì—­ê¸° ë¡œë“œ ì™„ë£Œ - ëª¨ë“  ê¸°ëŠ¥ í™œì„±í™”ë¨');
    </script>
</body>
</html>